<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用戶交易管理</title>
    <link rel="stylesheet" th:href="@{/css/model.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
    <!-- 頁面頭部和側邊欄 -->
    <div th:replace="~{model/layout-static}"></div>

    <!-- 主內容區域 -->
    <div class="container pt-5">
        <div class="dashboard-header d-flex align-items-center">
            <h1>用戶交易管理</h1>
            <div class="ms-auto d-flex">
				
				<!-- 新增交易按鈕 -->
        		<div class="text-center">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">新增交易</button>
       		 	</div>
       		</div>
        </div>

       
        

        <!-- 新增交易模態框 -->
        <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="addTransactionForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addModalLabel">新增交易</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            用戶ID: <input type="text" id="addUserId" name="userId" required class="form-control"><br>
                            
                            交易角色: 
                            <select id="addTransactionRole" name="transactionRole" required class="form-select">
                                <option value="sender">發送方</option>
                                <option value="receiver">接收方</option>
                            </select><br>
                            
                            交易類型: 
                            <select id="addTransactionType" name="transactionType" required class="form-select">
                                <option value="deposit">存入</option>
                                <option value="withdrawal">取出</option>
                                <option value="payment">付款</option>
                                <option value="refund">退款</option>
                            </select><br>
                            
                            金額: <input type="number" id="addAmount" name="totalAmount" required class="form-control" min="1"><br>
                            
                            平台抽成: <input type="number" id="addPlatformFee" name="platformFee" required class="form-control" min="0" step="0.01"><br>
                            
                            實際收入: <input type="number" id="addTargetIncome" name="targetIncome" class="form-control" min="0" step="0.01"><br>
                            
                            交易狀態: 
                            <select id="addTransactionStatus" name="transactionStatus" required class="form-select">
                                <option value="pending">待處理</option>
                                <option value="completed">已完成</option>
                                <option value="failed">失敗</option>
                            </select><br>
                            
                            支付方式: <input type="text" id="addPaymentMethod" name="paymentMethod" required class="form-control"><br>
                            
                            第三方支付參考ID: <input type="text" id="addReferenceId" name="referenceId" class="form-control"><br>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" id="addTransactionBtn" class="btn btn-primary">新增</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 更新交易模態框 -->
        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="updateTransactionForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="updateModalLabel">更新交易</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="transactionId" id="updateTransactionId"> 
                            用戶ID: <input type="text" id="updateUserId" name="userId" required class="form-control"><br>
                            交易角色: 
                            <select id="updateTransactionRole" name="transactionRole" required class="form-select">
                                <option value="sender">發送方</option>
                                <option value="receiver">接收方</option>
                            </select><br>
                            交易類型: 
                            <select id="updateTransactionType" name="transactionType" required class="form-select">
                                <option value="deposit">存入</option>
                                <option value="withdrawal">取出</option>
                                <option value="payment">付款</option>
                                <option value="refund">退款</option>
                            </select><br>
                            金額: <input type="number" id="updateAmount" name="totalAmount" required class="form-control" min="1"><br>
                            平台抽成: <input type="number" id="updatePlatformFee" name="platformFee" required class="form-control" min="0" step="0.01"><br>
                            實際收入: <input type="number" id="updateTargetIncome" name="targetIncome" class="form-control" min="0" step="0.01"><br>
                            交易狀態: 
                            <select id="updateTransactionStatus" name="transactionStatus" required class="form-select">
                                <option value="pending">待處理</option>
                                <option value="completed">已完成</option>
                                <option value="failed">失敗</option>
                            </select><br>
                            創建時間: <input type="text" id="updateCreatedAt" name="createdAt" class="form-control" readonly><br>
                            支付方式: <input type="text" id="updatePaymentMethod" name="paymentMethod" required class="form-control"><br>
                            參考ID: <input type="text" id="updateReferenceId" name="referenceId" class="form-control"><br>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" id="updateTransactionBtn" class="btn btn-primary">編輯</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 交易記錄表格 -->
        <div class="container mt-5 table-container">
            <table id="transactionsTable" class="table table-bordered table-striped table-hover">
                <thead>
                    <tr>
                        <th>交易ID</th>
                        <th>用戶ID</th>
                        <th>交易角色</th>
                        <th>交易類型</th>
                        <th>金額</th>
                        <th>平台抽成</th>
                        <th>實際收入</th>
                        <th>交易狀態</th>
                        <th>創建時間</th>
                        <th>完成時間</th>
                        <th>支付方式</th>
                        <th>參考ID</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody">
                    <!-- AJAX 填充表格内容 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 引入必要的 JS 庫 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入 DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
         // 頁面加載時自動查詢所有交易記錄並初始化 DataTables
        $(document).ready(function () {
            reloadTransactions();
        });

        // 初始化 DataTables
        function initDataTable() {
            // 檢查是否已經初始化 DataTable，避免重複初始化
            if (!$.fn.DataTable.isDataTable('#transactionsTable')) {
                $('#transactionsTable').DataTable({
                    "paging": true,                // 啟用分頁
                    "lengthMenu": [5, 10, 25, 50], // 每頁顯示的筆數選擇
                    "pageLength": 5,               // 預設每頁顯示5筆
                    "searching": true,             // 啟用搜尋功能
                    "ordering": true,              // 啟用排序功能
                    "info": true                   // 顯示表格下方的資訊
                });
            }
        }

        // 查詢交易記錄
        $("#searchBtn").click(function () {
            let formData = $("#searchForm").serialize();
            $.ajax({
                url: '/ProFit/userTransactions/search',
                type: 'GET',
                data: formData,
                success: function (response) {
                    populateTransactionTable(response);
                },
                error: function (xhr) {
                    showError(xhr.responseText);
                }
            });
        });

        // 新增交易
        $("#addTransactionBtn").click(function () {
            $.ajax({
                url: '/ProFit/userTransactions/insert',
                type: 'POST',
                data: $("#addTransactionForm").serialize(),
                success: function () {
                    $("#addModal").modal('hide');
                    clearModalBackdrop();
                    reloadTransactions();
                },
                error: function (xhr) {
                    showError(xhr.responseText);
                }
            });
        });

        // 更新交易
        $("#updateTransactionBtn").click(function () {
            let formData = $("#updateTransactionForm").serialize();
            $.ajax({
                url: '/ProFit/userTransactions/update',
                type: 'POST',
                data: formData,
                success: function () {
                    $("#updateModal").modal('hide');
                    clearModalBackdrop();
                    reloadTransactions();
                },
                error: function (xhr) {
                    showError(xhr.responseText);
                }
            });
        });

        // 刪除交易
        function deleteTransaction(transactionId) {
            if (confirm('確定要刪除這筆交易嗎？')) {
                $.ajax({
                    url: '/ProFit/userTransactions/delete',
                    type: 'POST',
                    data: { transactionId: transactionId },
                    success: function () {
                        reloadTransactions();
                    },
                    error: function (xhr) {
                        showError(xhr.responseText);
                    }
                });
            }
        }

        // 重新載入交易記錄
        function reloadTransactions() {
            $.ajax({
                url: '/ProFit/userTransactions/data',
                type: 'GET',
                success: function (response) {
                    populateTransactionTable(response);
                    initDataTable(); // 初始化 DataTables
                },
                error: function (xhr) {
                    showError(xhr.responseText);
                }
            });
        }

        // 填充表格數據
        function populateTransactionTable(transactions) {
            let tbody = $("#transactionsTableBody");
            tbody.empty();

            transactions.forEach(function (transaction) {
                let buttons = '';
                if (transaction.transactionStatus === 'pending') {
                    buttons = `
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#updateModal"
                                onclick="populateUpdateForm('${transaction.transactionId}', '${transaction.userId}', '${transaction.transactionRole}', '${transaction.transactionType}', '${transaction.totalAmount}', '${transaction.platformFee}', '${transaction.targetIncome}', '${transaction.transactionStatus}', '${transaction.createdAt}', '${transaction.paymentMethod}', '${transaction.referenceId}')">編輯</button>
                            <button type="button" class="btn btn-danger" onclick="deleteTransaction('${transaction.transactionId}')">刪除</button>
                        </div>`;
                } else {
                    buttons = `<span class="text-muted">無法更新/刪除</span>`;
                }

                let row = `<tr>
                    <td>${transaction.transactionId}</td>
                    <td>${transaction.userId}</td>
                    <td>${transaction.transactionRole}</td>
                    <td>${transaction.transactionType}</td>
                    <td>${transaction.totalAmount}</td>
                    <td>${transaction.platformFee}</td>
                    <td>${transaction.targetIncome ? transaction.targetIncome : '無'}</td>
                    <td>${transaction.transactionStatus}</td>
                    <td>${transaction.createdAt}</td>
                    <td>${transaction.completionAt ? transaction.completionAt : '未完成'}</td>
                    <td>${transaction.paymentMethod}</td>
                    <td>${transaction.referenceId ? transaction.referenceId : '無'}</td>
                    <td class="text-center">${buttons}</td>
                </tr>`;
                tbody.append(row);
            });
        }

        // 填充更新表單
        function populateUpdateForm(transactionId, userId, transactionRole, transactionType, totalAmount, platformFee, targetIncome, transactionStatus, createdAt, paymentMethod, referenceId) {
            $("#updateTransactionId").val(transactionId);
            $("#updateUserId").val(userId);
            $("#updateTransactionRole").val(transactionRole);
            $("#updateTransactionType").val(transactionType);
            $("#updateAmount").val(totalAmount);
            $("#updatePlatformFee").val(platformFee);
            $("#updateTargetIncome").val(targetIncome);
            $("#updateTransactionStatus").val(transactionStatus);
            $("#updateCreatedAt").val(createdAt);
            $("#updatePaymentMethod").val(paymentMethod);
            $("#updateReferenceId").val(referenceId);
        }

        // 清除模態框背景
        function clearModalBackdrop() {
            setTimeout(function () {
                $(".modal-backdrop").remove();
                $("body").removeClass("modal-open").css("overflow", "auto");
            }, 500);
        }

        // 顯示錯誤信息
        function showError(message) {
            $("#errorContainer").text(message).show();
        }
    </script>
</body>
</html>
